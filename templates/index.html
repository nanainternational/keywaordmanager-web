<!DOCTYPE html>
<html>
<head>
  <title>Keyword Manager Web</title>

  <!-- âœ… ëª¨ë°”ì¼ í™•ëŒ€ ë°©ì§€ í•µì‹¬ -->
  <meta name="viewport"
        content="width=device-width,
                 initial-scale=1,
                 maximum-scale=1,
                 user-scalable=no,
                 viewport-fit=cover">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --line:#1f2937;
      --text:#e2e8f0;
      --muted:#94a3b8;
      --field:#0b1220;
      --fieldLine:#334155;
      --green:#22c55e;
      --red:#ef4444;
      --blue:#2563eb;
      --blueLine:#1d4ed8;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:560px;
      margin:0 auto;
      padding:10px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }

    .gap{ height:10px; }

    /* ===== í™˜ìœ¨ ===== */
    .ratebar{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px 10px;
      display:flex;
      justify-content:space-between;
      font-size:12px;
    }

    /* ===== ê³µí†µ ===== */
    h3{
      margin:0;
      font-size:15px;
      font-weight:800;
    }
    .sub{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }

    input, textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--fieldLine);
      background:var(--field);
      color:var(--text);
      font-size:16px;          /* âœ… í™•ëŒ€ ë°©ì§€ í•µì‹¬ */
      outline:none;
    }

    textarea{
      resize:none;
    }

    button{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:0;
      font-weight:800;
      font-size:14px;
    }

    .btn-green{ background:var(--green); color:#03140b; }
    .btn-red{ background:var(--red); color:#fff; }
    .btn-ghost{ background:#334155; color:#fff; }

    /* =====================
       âœ… ì±„íŒ… (ë†’ì´ 2/3)
       ===================== */
    .chat-box{
      margin-top:10px;
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      height:30vh;        /* ğŸ”¥ ê¸°ì¡´ ~45vh â†’ 30vh */
      min-height:220px;
      overflow-y:auto;
    }

    .msg-row{ display:flex; margin:8px 0; }
    .msg-row.me{ justify-content:flex-end; }

    .bubble{
      max-width:85%;
      padding:10px 12px;
      border-radius:14px;
      background:#111827;
      border:1px solid var(--line);
      font-size:13px;
      line-height:1.35;
      word-break:break-word;
    }

    .msg-row.me .bubble{
      background:var(--blue);
      border:1px solid var(--blueLine);
      color:#fff;
    }

    .meta{
      margin-top:4px;
      font-size:10px;
      color:var(--muted);
    }

    .chat-input{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .chat-actions{
      display:flex;
      gap:8px;
    }

    .chat-actions button{
      width:50%;
    }

    /* ===== ë©”ëª¨ ===== */
    .memo-item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid var(--line);
      font-size:13px;
    }

    /* ===== ìº˜ë¦°ë” ===== */
    #calendar{
      margin-top:10px;
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:14px;
      padding:6px;
    }

    .fc .fc-toolbar-title{ font-size:14px; }
    .fc .fc-button{ font-size:12px; padding:6px 8px; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- í™˜ìœ¨ -->
  <div class="ratebar">
    <div>ğŸ‡¨ğŸ‡³ CNY <b>{{ exchange_rate }}</b></div>
  </div>

  <div class="gap"></div>

  <!-- ================= ì±„íŒ… ================= -->
  <div class="card">
    <h3>ğŸ’¬ ì±„íŒ…</h3>
    <div class="sub">2ì´ˆ ìë™ ìƒˆë¡œê³ ì¹¨</div>

    <input id="chatName" placeholder="ë‹‰ë„¤ì„" />

    <div id="chatBox" class="chat-box"></div>

    <div class="chat-input">
      <textarea id="chatMsg" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter ì „ì†¡)"></textarea>
      <div class="chat-actions">
        <button id="sendBtn" class="btn-green">ì „ì†¡</button>
        <button id="clearBtn" class="btn-ghost">ë¹„ìš°ê¸°</button>
      </div>
    </div>
  </div>

  <div class="gap"></div>

  <!-- ================= ë©”ëª¨ ================= -->
  <div class="card">
    <h3>ğŸ“ ë©”ëª¨</h3>

    <form method="POST">
      <input name="memo_keyword" placeholder="ë©”ëª¨ ì…ë ¥">
      <input type="hidden" name="action" value="add_memo">
      <div class="gap"></div>
      <button class="btn-green">ì¶”ê°€</button>
    </form>

    {% for memo in memo_list %}
      <div class="memo-item">
        <div>â€¢ {{ memo }}</div>
        <form method="POST">
          <input type="hidden" name="memo_keyword" value="{{ memo }}">
          <input type="hidden" name="action" value="delete_memo">
          <button class="btn-red" style="width:auto;">ì‚­ì œ</button>
        </form>
      </div>
    {% endfor %}
  </div>

  <div class="gap"></div>

  <!-- ================= ìº˜ë¦°ë” ================= -->
  <div class="card">
    <h3>ğŸ“… ìº˜ë¦°ë”</h3>
    <div class="sub">ë“œë˜ê·¸ ì¶”ê°€ Â· í´ë¦­ ìˆ˜ì •</div>
    <div id="calendar"></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
/* ================= ì±„íŒ… ================= */
let lastId = 0;

function escapeHtml(s){
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

async function loadChat(){
  const name = document.getElementById("chatName").value;
  const res = await fetch(`/api/chat/messages?after_id=${lastId}`);
  const data = await res.json();
  if(!data.ok) return;

  data.messages.forEach(m=>{
    lastId = Math.max(lastId, m.id);
    const row = document.createElement("div");
    row.className = "msg-row" + (m.sender === name ? " me":"");
    row.innerHTML = `
      <div class="bubble">
        ${m.sender !== name ? "<b>"+escapeHtml(m.sender)+"</b><br>" : ""}
        ${escapeHtml(m.message)}
        <div class="meta">${m.created_at}</div>
      </div>`;
    document.getElementById("chatBox").appendChild(row);
  });

  const box = document.getElementById("chatBox");
  box.scrollTop = box.scrollHeight;
}

async function sendChat(){
  const name = document.getElementById("chatName").value || "ìµëª…";
  const msgEl = document.getElementById("chatMsg");
  const msg = msgEl.value.trim();
  if(!msg) return;
  msgEl.value = "";

  await fetch("/api/chat/send",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ sender:name, message:msg })
  });

  loadChat();
}

document.getElementById("sendBtn").onclick = sendChat;
document.getElementById("clearBtn").onclick = ()=> {
  document.getElementById("chatBox").innerHTML="";
};

document.getElementById("chatMsg").addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendChat();
  }
});

setInterval(loadChat,2000);

/* ================= ìº˜ë¦°ë” ================= */
(async ()=>{
  const res = await fetch("/api/events");
  const events = await res.json();

  const calendar = new FullCalendar.Calendar(
    document.getElementById("calendar"),
    {
      initialView:"dayGridMonth",
      height:"auto",
      events,
      selectable:true,
      editable:true
    }
  );
  calendar.render();
})();
</script>
</body>
</html>
