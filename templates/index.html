<!doctype html>
<html lang="ko">
<head>  
  
  <!-- iOS PWA ê°•ì œ ì¸ì‹ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Keyword Manager">

<link rel="apple-touch-icon" href="/static/icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512.png">

<!-- viewport ì—†ìœ¼ë©´ ë°˜ë“œì‹œ ì¶”ê°€ -->
<!-- âœ… ëª¨ë°”ì¼ ì…ë ¥ì°½ ëˆŒë €ì„ ë•Œ í™•ëŒ€(ì¤Œ) ë°©ì§€ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">

  <title>Keyword Manager Web</title>
  <link rel="manifest" href="/manifest.webmanifest">


  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root {
      --bg: #0b0d10;
      --panel: #11141a;
      --line: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.90);
      --muted: rgba(255,255,255,.62);
      --chip: rgba(255,255,255,.08);
      --accent: #4da3ff;
      --danger: #ff5a6a;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;

      /* âœ… í°íŠ¸ 1 ì‘ê²Œ + ì–‡ê²Œ */
      font-size: 14px;
      font-weight: 300;
      overscroll-behavior: none;
    }

    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 10px 10px 16px;
    }

    /* âœ… í™˜ìœ¨ ì„¹ì…˜: ìµœì†Œí™”(ì‘ê²Œ) */
    .rate-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 7px 10px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 12px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .rate-bar .label { color: var(--muted); font-weight: 300; }
    .rate-bar .val { font-weight: 600; letter-spacing: .2px; }

    .section {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 2px 2px 10px;
    }
    .section-title h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: .15px;
    }
    .hint { color: var(--muted); font-size: 11px; font-weight: 300; }

    button.mini {
      width: auto;
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .mini.icon-btn{
      width: 38px;
      padding: 7px 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .refresh-icon{
      display: inline-block;
      font-size: 16px;
      line-height: 1;
      transform-origin: 50% 50%;
    }
    .spinning .refresh-icon{
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    /* âœ… ì±„íŒ… */
    .chat-box {
      height: 220px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chat-messages {
      flex: 1;
      overflow: auto;
      padding: 8px;
      border-radius: 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
    }
    .msg {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: flex-start;
    }

    .msg.me { justify-content: flex-end; }
    .msg.me .bubble {
      background: rgba(77,163,255,.16);
      border-color: rgba(77,163,255,.26);
    }
    .msg.me .meta { text-align: right; }

    .bubble {
      max-width: 80%;
      padding: 9px 11px;
      border-radius: 14px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--line);
      line-height: 1.25;
      font-size: 13px;
      font-weight: 300;
      word-break: break-word;
    }
    .bubble b { font-weight: 600; }
    .meta {
      color: var(--muted);
      font-size: 10px;
      margin-top: 3px;
      font-weight: 300;
    }

    .chat-input-row {
      width: 100%;
      display: grid;
      grid-template-columns: 82px 1fr 70px;
      gap: 8px;
      align-items: center;
    }
    .chat-input-row > * { min-width: 0; }

    input, textarea, button {
      font: inherit;
      color: var(--text);
      outline: none;
    }

    input[type="text"], textarea {
      font-size: 16px;
      font-weight: 300;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
    }

    button {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 10px 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      touch-action: manipulation; /* âœ… ëª¨ë°”ì¼ íƒ­ ë°˜ì‘ ê°œì„  */
    }
    button.primary {
      background: rgba(77,163,255,.18);
      border-color: rgba(77,163,255,.28);
    }
    button.danger {
      background: rgba(255,90,106,.16);
      border-color: rgba(255,90,106,.26);
    }
    button:disabled {
      opacity: .55;
      cursor: not-allowed;
    }

    /* âœ… ë©”ëª¨ */
    .memo-row {
      display: grid;
      grid-template-columns: 1fr 92px;
      gap: 8px;
      margin-bottom: 10px;
    }
    .memo-row > * { min-width: 0; }
    .memo-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 9px;
      background: var(--chip);
      border: 1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      font-weight: 300;
    }
    .chip form { margin: 0; }
    .chip button {
      width: auto;
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    /* âœ… ìº˜ë¦°ë”: ë°•ìŠ¤ ì œê±° + í¬ê²Œ */
    .calendar-wrap {
      padding: 0;
      border: none;
      background: transparent;
    }
    #calendar {
      width: 100%;
      min-height: 560px;
      background: transparent;
    }

    .fc { font-size: 13px; font-weight: 300; }
    .fc .fc-toolbar-title { font-size: 15px; font-weight: 600; }
    .fc .fc-button {
      border-radius: 10px !important;
      border: 1px solid var(--line) !important;
      background: rgba(255,255,255,.06) !important;
      color: var(--text) !important;
      box-shadow: none !important;
      font-weight: 600 !important;
    }
    .fc .fc-button:hover { background: rgba(255,255,255,.10) !important; }
    .fc-theme-standard td, .fc-theme-standard th { border-color: rgba(255,255,255,.06); }
    .fc .fc-scrollgrid, .fc .fc-scrollgrid-section > * { border-color: rgba(255,255,255,.06); }

    .ev-row {
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .ev-title { overflow: hidden; text-overflow: ellipsis; }
    .ev-time { opacity: .75; flex: 0 0 auto; }

    /* âœ… presence */
    .presence-bar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 8px;
      border-radius:12px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 10px;
    }
    .presence-avatars{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex-wrap:nowrap;
    }
    .presence-item{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      flex:0 0 auto;
    }
    .presence-time{
      font-size:10px;
      color: rgba(255,255,255,.62);
      line-height: 1;
      margin-top:2px;
      white-space:nowrap;
    }

    .presence-avatar{
      width:34px;
      height:34px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:700;
      position:relative;
      flex:0 0 auto;
      user-select:none;
    }
    .presence-avatar.online{
      background:#4da3ff;
      color:#fff;
    }
    .presence-avatar.offline{
      background:#6b7280;
      color:#fff;
      opacity:.65;
    }
    /* âœ… ì ‘ì† ìƒíƒœ ì  (ì¸ìŠ¤íƒ€ ëŠë‚Œ) */
    .presence-avatar::before{
      content:"";
      position:absolute;
      right:-2px;
      bottom:-2px;
      width:10px;
      height:10px;
      border-radius:50%;
      border:2px solid var(--panel, #11141a);
      background:#9ca3af;
    }
    .presence-avatar.online::before{
      background:#22c55e;
    }
    .presence-avatar:hover::after{
      content:attr(data-label);
      position:absolute;
      left:50%;
      bottom:-34px;
      transform:translateX(-50%);
      background:#000;
      color:#fff;
      padding:4px 8px;
      border-radius:8px;
      font-size:11px;
      white-space:nowrap;
      pointer-events:none;
      z-index:50;
    }

    @media (max-width: 480px) {
      .wrap { padding: 10px 10px 16px; }
      .chat-input-row { grid-template-columns: 76px 1fr 66px; }
      .chat-box { height: 200px; }
      #calendar { min-height: 620px; }
      .fc .fc-toolbar { flex-wrap: wrap; gap: 6px; }
      .modal .grid { grid-template-columns: 1fr; }
    }

    /* âœ… ëª¨ë‹¬ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 9999;
      pointer-events: auto;
    }
    .modal {
      width: 100%;
      max-width: 520px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      pointer-events: auto;
    }
    .modal h4 { margin: 4px 2px 10px; font-size: 14px; font-weight: 600; }
    .modal .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .modal .row { display: grid; gap: 6px; margin-bottom: 8px; }
    .modal label { color: var(--muted); font-size: 11px; font-weight: 300; }
    .modal textarea { min-height: 88px; resize: none; }
    .modal .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="rate-bar">
      <div class="label">ì¤‘êµ­(CNY) ì¡°ì • í™˜ìœ¨</div>
      <div class="val">{{ exchange_rate if exchange_rate else "-" }}</div>
    </div>

    <div class="section">
      <div class="section-title">
        <h3>ì±„íŒ…</h3>
        
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="mini icon-btn" id="noticeSettingsBtn" type="button" onclick="openNoticeSettingsModal(event)" aria-label="ê³µì§€ì„¤ì •" style="width:44px;">
            <span aria-hidden="true" style="font-size:18px; line-height:1;">ğŸ””</span>
            <div style="font-size:10px; margin-top:2px; color:rgba(255,255,255,.75); font-weight:600;">ê³µì§€ì„¤ì •</div>
          </button>

          <button class="mini icon-btn" id="androidInstallBtn" type="button" onclick="triggerAndroidInstall(event)" aria-label="Android ì„¤ì¹˜" style="width:44px; display:none;">
            <span aria-hidden="true" style="font-size:18px; line-height:1;">â¬‡ï¸</span>
            <div style="font-size:10px; margin-top:2px; color:rgba(255,255,255,.75); font-weight:600;">Androidì„¤ì¹˜</div>
          </button>

          <button class="mini icon-btn" id="iosHowtoBtn" type="button" onclick="openIosInstallModal(event)" aria-label="iOS ì„¤ì¹˜ë°©ë²•" style="width:44px; display:none;">
            <span aria-hidden="true" style="font-size:18px; line-height:1;">ğŸ“±</span>
            <div style="font-size:10px; margin-top:2px; color:rgba(255,255,255,.75); font-weight:600;">iOSì„¤ì¹˜</div>
          </button>



          <!-- (ê¸°ì¡´ í…ŒìŠ¤íŠ¸/ì•Œë¦¼ ë²„íŠ¼ì€ ì„¤ì • ëª¨ë‹¬ë¡œ ì´ë™) -->
        </div>

      </div>

      <div class="presence-bar">
        <div id="presenceList" class="presence-avatars"></div>
      </div>

      <div class="chat-box">
        <div id="chatMessages" class="chat-messages"></div>

        <div class="chat-input-row">
          <input id="chatSender" type="text" placeholder="ì´ë¦„" value="ë‚˜ë‚˜" autocomplete="off" inputmode="text">
          <input id="chatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" inputmode="text">
          <button class="primary" id="sendBtn" type="button">ì „ì†¡</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <h3>ë©”ëª¨</h3>
        <button class="mini icon-btn" id="refreshMemosBtn" type="button" aria-label="ìƒˆë¡œê³ ì¹¨"><span class="refresh-icon" aria-hidden="true">âŸ³</span></button>
      </div>

      <form method="POST" class="memo-row">
        <input type="text" name="memo_keyword" placeholder="ë©”ëª¨ ì¶”ê°€..." autocomplete="off" inputmode="text">
        <button class="primary" type="submit" name="action" value="add_memo">ì¶”ê°€</button>
      </form>

      <div class="memo-list">
        {% for m in memo_list %}
          <div class="chip">
            <span>{{ m }}</span>
            <form method="POST">
              <input type="hidden" name="memo_keyword" value="{{ m }}">
              <button class="danger" type="submit" name="action" value="delete_memo">ì‚­ì œ</button>
            </form>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="calendar-wrap">
      <div class="section-title" style="margin: 6px 2px 10px;">
        <h3>ìº˜ë¦°ë”</h3>
        <button class="mini icon-btn" id="refreshCalendarBtn" type="button" aria-label="ìƒˆë¡œê³ ì¹¨"><span class="refresh-icon" aria-hidden="true">âŸ³</span></button>
      </div>
      <div id="calendar"></div>
    </div>
  </div>

  <!-- âœ… ëª¨ë‹¬ -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h4 id="modalTitle">ì¼ì • ì¶”ê°€</h4>

      <div class="row">
        <label>ì œëª©</label>
        <input id="evTitle" type="text" placeholder="ì˜ˆ: ë¯¸íŒ… / ë°œì£¼ / ìƒë‹´" autocomplete="off" inputmode="text">
      </div>

      <div class="grid">
        <div class="row">
          <label>ì‹œì‘</label>
          <input id="evStart" type="text" placeholder="YYYY-MM-DD ë˜ëŠ” YYYY-MM-DDTHH:mm" autocomplete="off" inputmode="text">
        </div>
        <div class="row">
          <label>ë(ì„ íƒ)</label>
          <input id="evEnd" type="text" placeholder="YYYY-MM-DD ë˜ëŠ” YYYY-MM-DDTHH:mm" autocomplete="off" inputmode="text">
        </div>
      </div>

      <div class="row">
        <label>ë©”ëª¨(ì„ íƒ)</label>
        <textarea id="evMemo" placeholder="ë‚´ìš©/ë©”ëª¨"></textarea>
      </div>

      <div class="actions">
        <button id="evDelete" class="danger" type="button" style="display:none;">ì‚­ì œ</button>
        <button id="evCancel" type="button">ì·¨ì†Œ</button>
        <button id="evSave" class="primary" type="button">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script src="/static/pwa-push.js"></script>

  <script>
    // =========================
    // âœ… ê³µí†µ fetch helpers
    // =========================
    async function jget(url){
      const r = await fetch(url, { credentials: "same-origin" });
      return await r.json();
    }
    async function jpost(url, body){
      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
        credentials: "same-origin",
      });
      return await r.json();
    }
    async function jdel(url){
      const r = await fetch(url, { method: "DELETE", credentials: "same-origin" });
      return await r.json();
    }
    async function jput(url, body){
      const r = await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
        credentials: "same-origin",
      });
      return await r.json();
    }

    // =========================
    // âœ… ì±„íŒ…
    // =========================
    const chatBox = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSender = document.getElementById("chatSender");
    const sendBtn = document.getElementById("sendBtn");

    const CHAT_ROOM = "main";
    let lastChatId = 0;

    function updateChatEnabled(){
      const nameOk = (chatSender.value || "").trim().length > 0;
      sendBtn.disabled = !nameOk;
      chatInput.disabled = !nameOk;
    }

    function formatChatTime(iso){
      if (!iso) return "";
      try {
        const d = new Date(iso);
        return d.toLocaleString("ko-KR", { hour12: true, month: "numeric", day: "numeric", hour: "numeric", minute: "2-digit" });
      } catch(e){
        return "";
      }
    }

    function appendMsg(m){
      const me = (m.client_id && m.client_id === CLIENT_ID);

      const wrap = document.createElement("div");
      wrap.className = "msg" + (me ? " me" : "");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `<b>${escapeHtml(m.sender || "ìµëª…")}</b><br>${escapeHtml(m.message || "")}`;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = formatChatTime(m.created_at);

      const col = document.createElement("div");
      col.appendChild(bubble);
      col.appendChild(meta);

      wrap.appendChild(col);
      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function pollChatOnce(){
      const data = await jget(`/api/chat/messages?room=${encodeURIComponent(CHAT_ROOM)}&after_id=${lastChatId}`);
      if (data && data.ok && Array.isArray(data.messages)) {
        for (const m of data.messages) {
          appendMsg(m);
          lastChatId = Math.max(lastChatId, m.id);
        }
      }
    }

    let chatPollTimer = null;
    async function pollChat(){
      if (chatPollTimer) clearTimeout(chatPollTimer);

      if (document.hidden) {
        chatPollTimer = setTimeout(pollChat, 5000);
        return;
      }

      try { await pollChatOnce(); } catch(e) {}
      chatPollTimer = setTimeout(pollChat, 2000);
    }

    // âœ… ë¸Œë¼ìš°ì €/ê¸°ê¸°ë³„ ê³ ìœ  ID (ë¡œê·¸ì¸ ì—†ì´ "ë‚´ ê¸€" êµ¬ë¶„)
    let CLIENT_ID = localStorage.getItem("chat_client_id");
    if (!CLIENT_ID) {
      try {
        CLIENT_ID = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2));
      } catch (e) {
        CLIENT_ID = (Date.now().toString(36) + Math.random().toString(36).slice(2));
      }
      localStorage.setItem("chat_client_id", CLIENT_ID);
    }

    // âœ… ê¸°ê¸°/ë¸Œë¼ìš°ì €ë³„ ë™ë¬¼ ë³„ëª… (client_idê°€ ë‹¤ë¥´ë©´ ìë™ìœ¼ë¡œ êµ¬ë¶„ë˜ê²Œ)
    const ANIMAL_KEY = "chat_animal_alias";
    const ANIMALS = [
      "ê³ ì–‘ì´","ê°•ì•„ì§€","í† ë¼","ì—¬ìš°","ê³°","ì‚¬ì","í˜¸ë‘ì´","íŒë‹¤","í­ê·„","ëŒê³ ë˜",
      "ìˆ˜ë‹¬","ì½”ì•Œë¼","ê¸°ë¦°","ì½”ë¼ë¦¬","ì¹˜íƒ€","ëŠ‘ëŒ€","í•˜ë§ˆ","ì•ŒíŒŒì¹´","ë‹¤ëŒì¥","ê³ ìŠ´ë„ì¹˜",
      "ì•µë¬´ìƒˆ","ë¶€ì—‰ì´","ë…ìˆ˜ë¦¬","ê±°ë¶ì´","ì•…ì–´","ì°¸ìƒˆ","ë‘ë”ì§€","ë„ˆêµ¬ë¦¬","í–„ìŠ¤í„°","ë¼ì¿¤"
    ];
    function _hash32(str){
      let h = 2166136261;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    let ANIMAL_ALIAS = localStorage.getItem(ANIMAL_KEY);
    if (!ANIMAL_ALIAS) {
      try {
        const n = _hash32(CLIENT_ID);
        ANIMAL_ALIAS = ANIMALS[n % ANIMALS.length];
      } catch(e) {
        ANIMAL_ALIAS = ANIMALS[Math.floor(Math.random()*ANIMALS.length)];
      }
      localStorage.setItem(ANIMAL_KEY, ANIMAL_ALIAS);
    }

    // âœ… ì´ë¦„(ë³´ë‚¸ì‚¬ëŒ) ê¸°ê¸°ë³„ ì €ì¥ (PC/í° ê°ê° ìœ ì§€)
    const NAME_KEY = "chat_sender_name";
    const savedName = localStorage.getItem(NAME_KEY);
    if (savedName && savedName.trim()) {
      chatSender.value = savedName.trim();
    }
    const saveName = () => {
      const v = (chatSender.value || "").trim();
      if (v) localStorage.setItem(NAME_KEY, v);
    };
    chatSender.addEventListener("change", saveName);
    chatSender.addEventListener("blur", saveName);

    updateChatEnabled();

    // âœ… ìµœê·¼ ì ‘ì†ì(Presence)
    const presenceListEl = document.getElementById("presenceList");
    let presenceTimer = null;
    let presencePingTimer = null;

    async function presencePing(){
      try {
        await jpost("/api/presence/ping", {
          client_id: CLIENT_ID,
          sender: (chatSender.value || "").trim() || "ìµëª…",
          animal: ANIMAL_ALIAS
        });
      } catch(e) {}
    }

    function formatPresenceTime(iso){
      if (!iso) return "";
      try {
        const diffMin = Math.floor((Date.now() - new Date(iso)) / 60000);

        // âœ… ìµœê·¼ 2ë¶„ ì´ë‚´: ì ‘ì†ì¤‘
        if (diffMin < 2) return "ì ‘ì†ì¤‘";

        // âœ… 1~59ë¶„: në¶„ì „
        if (diffMin < 60) return `${diffMin}ë¶„ì „`;

        // âœ… 1~23ì‹œê°„: nì‹œê°„ì „
        const h = Math.floor(diffMin / 60);
        if (h < 24) return `${h}ì‹œê°„ì „`;

        // âœ… 24ì‹œê°„ ì´ìƒ: nì¼ì „ / në‹¬ì „
        const d = Math.floor(diffMin / 1440); // 1440 = 60*24
        if (d < 30) return `${d}ì¼ì „`;
        const mo = Math.floor(d / 30);
        return `${mo}ë‹¬ì „`;
      } catch(e){
        return "";
      }
    }

    async function presenceRefresh(){
      try {
        // âœ… 2~5ëª… ì†Œìˆ˜ ì‚¬ìš© ê¸°ì¤€: ìµœê·¼ ê¸°ë¡ê¹Œì§€ ê°€ì ¸ì™€ì„œ "në¶„ì „/nì‹œê°„ì „/nì¼ì „/në‹¬ì „" í‘œê¸°
        const data = await jget("/api/presence/list?minutes=525600");
        if (!data || !data.ok) return;

        const users = (data.users || []).map(u => ({
          client_id: (u.client_id || ""),
          name: ((u.sender || "").trim()) || ((u.animal || "").trim()) || "ìµëª…",
          last_seen: (u.last_seen || null),
        }));

        // âœ… ìµœê·¼ ìˆœìœ¼ë¡œ ìµœëŒ€ 8ê°œë§Œ
        const slice = users.slice(0, 8);

        const frag = document.createDocumentFragment();
        slice.forEach(u => {
          const state = formatPresenceTime(u.last_seen);
          const online = (state === "ì ‘ì†ì¤‘");

          const item = document.createElement("div");
          item.className = "presence-item";

          const el = document.createElement("div");
          el.className = "presence-avatar " + (online ? "online" : "offline");
          el.textContent = (u.name || "ìµëª…").charAt(0);
          el.setAttribute("data-label", `${u.name} Â· ${state}`);

          const t = document.createElement("div");
          t.className = "presence-time";
          t.textContent = state;

          item.appendChild(el);
          item.appendChild(t);

          frag.appendChild(item);
        });

        presenceListEl.innerHTML = "";
        presenceListEl.appendChild(frag);
        if (!slice.length) presenceListEl.textContent = "-";
      } catch(e) {}
    }

    function startPresence(){
      if (presencePingTimer) clearInterval(presencePingTimer);
      if (presenceTimer) clearInterval(presenceTimer);

      presencePing();
      presenceRefresh();

      // 30ì´ˆë§ˆë‹¤ ì ‘ì† ìœ ì§€ ì‹ í˜¸
      presencePingTimer = setInterval(() => {
        if (!document.hidden) presencePing();
      }, 30000);

      // 15ì´ˆë§ˆë‹¤ ëª©ë¡ ê°±ì‹ 
      presenceTimer = setInterval(() => {
        if (!document.hidden) presenceRefresh();
      }, 15000);
    }

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        pollChat();
        startPresence();
      }
    });

    async function sendChat(){
      saveName();
      const sender = (chatSender.value || "ìµëª…").trim();
      const message = (chatInput.value || "").trim();
      if (!message) return;

      sendBtn.disabled = true;
      chatInput.disabled = true;

      try {
        chatInput.value = "";
        const res = await jpost("/api/chat/send", { room: CHAT_ROOM, sender, message, client_id: CLIENT_ID });

        // âœ… ì„œë²„ê°€ id/created_atì„ ì£¼ë©´, í´ë§ ê¸°ë‹¤ë¦¬ì§€ ë§ê³  ì¦‰ì‹œ ì¶”ê°€
        if (res && res.ok) {
          appendMsg({ id: res.id, sender, message, created_at: res.created_at || "", client_id: CLIENT_ID });
          lastChatId = Math.max(lastChatId, res.id || lastChatId);
        } else {
          // ì‹¤íŒ¨í•˜ë©´ í•œ ë²ˆ ë” í´ë§
          await pollChatOnce();
        }
      } catch(e){
        try { await pollChatOnce(); } catch(e2) {}
      } finally {
        updateChatEnabled();
        chatInput.focus();
      }
    }

    sendBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); sendChat(); });
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); sendChat(); }
    });

    // =========================
    // âœ… ìº˜ë¦°ë” + ëª¨ë‹¬ (ì €ì¥ ë²„íŠ¼ ì•ˆëˆŒë¦¼ ê°œì„ )
    // - ë²„íŠ¼ type=button
    // - í´ë¦­ì‹œ stopPropagation
    // =========================
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const evTitle = document.getElementById("evTitle");
    const evStart = document.getElementById("evStart");
    const evEnd = document.getElementById("evEnd");
    const evMemo = document.getElementById("evMemo");
    const evSave = document.getElementById("evSave");
    const evCancel = document.getElementById("evCancel");
    const evDelete = document.getElementById("evDelete");

    let currentEventId = null;
    let calendar = null;

    function openModal(mode, payload) {
      currentEventId = payload?.id ?? null;

      modalTitle.textContent = mode === "edit" ? "ì¼ì • ìˆ˜ì •" : "ì¼ì • ì¶”ê°€";
      evDelete.style.display = mode === "edit" ? "inline-flex" : "none";

      evTitle.value = payload?.title || "";
      evStart.value = payload?.start || "";
      evEnd.value = payload?.end || "";
      evMemo.value = payload?.memo || "";

      modalBackdrop.style.display = "flex";
    }

    function closeModal() {
      modalBackdrop.style.display = "none";
      currentEventId = null;
    }

    evCancel.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); closeModal(); });
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    evSave.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      const title = (evTitle.value || "").trim();
      const start = (evStart.value || "").trim();
      const end = (evEnd.value || "").trim();
      const memo = (evMemo.value || "").trim();

      if (!title || !start) return;

      evSave.disabled = true;

      try {
        if (currentEventId) {
          await jput(`/api/events/${currentEventId}`, { title, start, end: end || null, memo });
        } else {
          await jpost("/api/events", { title, start, end: end || null, allDay: false, memo });
        }
        closeModal();
        calendar.refetchEvents();
      } catch (e2) {
      } finally {
        evSave.disabled = false;
      }
    });

    evDelete.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (!currentEventId) return;
      if (!confirm("ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?")) return;

      evDelete.disabled = true;

      try {
        await jdel(`/api/events/${currentEventId}`);
        closeModal();
        calendar.refetchEvents();
      } catch (e2) {
      } finally {
        evDelete.disabled = false;
      }
    });

    async function initCalendar() {
      const calEl = document.getElementById("calendar");

      calendar = new FullCalendar.Calendar(calEl, {
        initialView: "dayGridMonth",
        timeZone: "Asia/Seoul",
        displayEventTime: false,
        height: "auto",
        expandRows: true,
        nowIndicator: true,

        selectable: true,
        selectMirror: true,
        longPressDelay: 180,
        selectLongPressDelay: 180,

        events: async (info, success, failure) => {
          try {
            const data = await jget("/api/events");
            success(data || []);
          } catch (e) {
            failure(e);
          }
        },

        dateClick: (arg) => {
          openModal("add", { title: "", start: arg.dateStr, end: "", memo: "" });
        },

        select: (sel) => {
          openModal("add", { title: "", start: sel.startStr, end: sel.endStr || "", memo: "" });
        },

        eventClick: (info) => {
          const e = info.event;
          openModal("edit", {
            id: e.id,
            title: e.title,
            start: e.startStr,
            end: e.endStr || "",
            memo: (e.extendedProps && e.extendedProps.memo) ? e.extendedProps.memo : ""
          });
        },

        eventContent: (arg) => {
          const wrap = document.createElement("span");
          wrap.className = "ev-row";

          const title = document.createElement("span");
          title.className = "ev-title";
          title.textContent = arg.event.title || "";

          const time = document.createElement("span");
          time.className = "ev-time";
          time.textContent = arg.timeText ? ` ${arg.timeText}` : "";

          wrap.appendChild(title);
          if (arg.timeText) wrap.appendChild(time);

          return { domNodes: [wrap] };
        }
      });

      calendar.render();
    }

    // âœ… FullCalendar init
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await initCalendar();

        // âœ… ì±„íŒ… ì‹œì‘
        pollChat();
        startPresence();

        // âœ… ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        document.getElementById("refreshCalendarBtn")?.addEventListener("click", (e) => {
          e.preventDefault(); e.stopPropagation();
          const btn = document.getElementById("refreshCalendarBtn");
          if (btn) btn.classList.add("spinning");
          try { if (calendar) calendar.refetchEvents(); } catch(e2) {}
          setTimeout(() => { if (btn) btn.classList.remove("spinning"); }, 800);
        });

      } catch(e) {}
    });

    // âœ… ë©”ëª¨ ìƒˆë¡œê³ ì¹¨(ê·¸ëŒ€ë¡œ ìœ ì§€)
    const refreshMemosBtn = document.getElementById("refreshMemosBtn");
    if (refreshMemosBtn) {
      refreshMemosBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        refreshMemosBtn.classList.add("spinning");
        setTimeout(() => window.location.reload(), 60);
      });
    }
  
    // =========================
    // âœ… ê³µì§€ì„¤ì •(ğŸ””) - ì•Œë¦¼ ê¶Œí•œ/í…ŒìŠ¤íŠ¸
    // =========================
    const noticeSettingsBtn = document.getElementById("noticeSettingsBtn");
    const noticeSettingsModal = document.getElementById("noticeSettingsModal");
    const noticeSettingsCloseBtn = document.getElementById("noticeSettingsCloseBtn");
    const noticeEnableBtn = document.getElementById("noticeEnableBtn");
    const noticeTestBtn = document.getElementById("noticeTestBtn");
    const noticePermissionState = document.getElementById("noticePermissionState");

    function _updateNoticePermissionText(){
      try{
        const p = (window.Notification && Notification.permission) ? Notification.permission : "unsupported";
        const map = { "granted":"í—ˆìš©ë¨", "denied":"ì°¨ë‹¨ë¨", "default":"ë¯¸ì„¤ì •", "unsupported":"ë¯¸ì§€ì›" };
        if (noticePermissionState) noticePermissionState.textContent = "ê¶Œí•œ ìƒíƒœ: " + (map[p] || p);
        if (noticeEnableBtn) {
          noticeEnableBtn.disabled = (p === "granted" || p === "unsupported");
          noticeEnableBtn.textContent = (p === "granted") ? "ì•Œë¦¼ ì¼œì§" : "ì•Œë¦¼ ì¼œê¸°";
        }
      }catch(e){}
    }

    if (noticeSettingsBtn) {
      noticeSettingsBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        if (noticeSettingsModal) noticeSettingsModal.style.display = "flex";
        _updateNoticePermissionText();
      });
    }
    if (noticeSettingsCloseBtn) {
      noticeSettingsCloseBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        if (noticeSettingsModal) noticeSettingsModal.style.display = "none";
      });
    }
    if (noticeSettingsModal) {
      noticeSettingsModal.addEventListener("click", (e) => {
        if (e.target === noticeSettingsModal) noticeSettingsModal.style.display = "none";
      });
    }

    // âœ… ì•Œë¦¼ ì¼œê¸°: ê¸°ì¡´ pwa-push.js í•¨ìˆ˜ ì¬ì‚¬ìš©
    if (noticeEnableBtn) {
      noticeEnableBtn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        try {
          const name = ((document.getElementById("chatSender")?.value || "ìµëª…").trim()) || "ìµëª…";
          if (typeof pwaEnableNotifications === "function") {
            await pwaEnableNotifications(name);
          } else {
            alert("pwaEnableNotifications í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. /static/pwa-push.js í™•ì¸ í•„ìš”");
          }
        } catch (e2) {
        } finally {
          _updateNoticePermissionText();
        }
      });
    }

    // âœ… í…ŒìŠ¤íŠ¸ ì•Œë¦¼: ì„œë¹„ìŠ¤ìš©ì—ì„œëŠ” ìˆ¨ê¸°ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ë§Œ ë§‰ìœ¼ë©´ ë¨
    if (noticeTestBtn) {
      noticeTestBtn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        try {
          const name = ((document.getElementById("chatSender")?.value || "ìµëª…").trim()) || "ìµëª…";
          if (typeof pwaTestPush === "function") {
            await pwaTestPush(name);
          } else {
            alert("pwaTestPush í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. /static/pwa-push.js í™•ì¸ í•„ìš”");
          }
        } catch (e2) {}
      });
    }

    // ì´ˆê¸° ë°˜ì˜
    _updateNoticePermissionText();

  
    // =========================
    // âœ… PWA ì„¤ì¹˜(Android / iOS)
    // =========================
    const _ua = navigator.userAgent || "";
    const _isAndroid = /Android/i.test(_ua);
    const _isIOS = /iPhone|iPad|iPod/i.test(_ua);
    const _isStandalone =
      (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
      (window.navigator.standalone === true);

    const androidInstallBtn = document.getElementById("androidInstallBtn");
    
    // SHOW_ANDROID_INSTALL_ON_LOAD
    try{
      if (_isAndroid && !_isStandalone && androidInstallBtn) {
        androidInstallBtn.style.display = "inline-flex";
      }
    }catch(_){}
const iosHowtoBtn = document.getElementById("iosHowtoBtn");
    const iosInstallModal = document.getElementById("iosInstallModal");
    const iosInstallCloseBtn = document.getElementById("iosInstallCloseBtn");

    // iOS: ì„¤ì¹˜ ì•ˆë‚´
    if (_isIOS && !_isStandalone && iosHowtoBtn) {
      iosHowtoBtn.style.display = "inline-flex";
      iosHowtoBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        if (iosInstallModal) iosInstallModal.style.display = "flex";
      });
    }
    if (iosInstallCloseBtn) {
      iosInstallCloseBtn.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        if (iosInstallModal) iosInstallModal.style.display = "none";
      });
    }
    if (iosInstallModal) {
      iosInstallModal.addEventListener("click", (e) => {
        if (e.target === iosInstallModal) iosInstallModal.style.display = "none";
      });
    }

    // Android: beforeinstallpromptë¡œ ì„¤ì¹˜ íŒì—… ì œì–´
    window.__window.__deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      window.__deferredPrompt = e;
      if (_isAndroid && !_isStandalone && androidInstallBtn) {
        androidInstallBtn.style.display = "inline-flex";
      }
    });

    if (androidInstallBtn) {
      androidInstallBtn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        if (!window.__deferredPrompt) {
          alert("ì•„ì§ ì„¤ì¹˜ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (manifest/service-worker ì¡°ê±´ í™•ì¸ í•„ìš”)");
          return;
        }
        window.__deferredPrompt.prompt();
        try { await window.__deferredPrompt.userChoice; } catch (_) {}
        window.__deferredPrompt = null;
        androidInstallBtn.style.display = "none";
      });
    }

    window.addEventListener("appinstalled", () => {
      if (androidInstallBtn) androidInstallBtn.style.display = "none";
    });

  
    // =========================
    // âœ… ì„¤ì¹˜/ì„¤ì • ë²„íŠ¼(ì¸ë¼ì¸ onclickìš©)
    // =========================
    function openNoticeSettingsModal(e){
      try{ if(e){ e.preventDefault(); e.stopPropagation(); } }catch(_){}
      const modal = document.getElementById("noticeSettingsModal");
      if (modal) modal.style.display = "flex";
      try{ if (typeof _updateNoticePermissionText === "function") _updateNoticePermissionText(); }catch(_){}
    }
    function openIosInstallModal(e){
      try{ if(e){ e.preventDefault(); e.stopPropagation(); } }catch(_){}
      const modal = document.getElementById("iosInstallModal");
      if (modal) modal.style.display = "flex";
    }
    async function triggerAndroidInstall(e){
      try{ if(e){ e.preventDefault(); e.stopPropagation(); } }catch(_){}
      // deferredPromptëŠ” beforeinstallpromptì—ì„œ ì¡í˜
      if (!window.__deferredPrompt) {
        alert("ì•„ì§ ì„¤ì¹˜ ì¡°ê±´ì´ ì¡íˆì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n1) í¬ë¡¬ ë©”ë‰´(â‹®)ì— 'ì•± ì„¤ì¹˜'ê°€ ìˆëŠ”ì§€ í™•ì¸\n2) ì—†ë‹¤ë©´ ì‚¬ì´íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œ í›„ ë‹¤ì‹œ ì ‘ì†\n3) ì ì‹œ ì‚¬ìš© í›„ ë‹¤ì‹œ ì‹œë„");
        return;
      }
      window.__window.__deferredPrompt.prompt();
      try { await window.__deferredPrompt.userChoice; } catch(_) {}
      window.__window.__deferredPrompt = null;
      const btn = document.getElementById("androidInstallBtn");
      if (btn) btn.style.display = "none";
    }

  </script>

  <!-- âœ… ê³µì§€ ì„¤ì • ëª¨ë‹¬(ì•Œë¦¼ ê¶Œí•œ/êµ¬ë…) -->
  <div id="noticeSettingsModal" class="modal-backdrop" style="display:none;">
    <div class="modal" style="max-width:520px;">
      <h4 style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <span>ê³µì§€ ì„¤ì •</span>
        <button id="noticeSettingsCloseBtn" type="button" class="mini" style="width:auto; padding:8px 10px;">ë‹«ê¸°</button>
      </h4>

      <div class="hint" style="margin:0 2px 10px;">
        ê³µì§€/ì•Œë¦¼ì„ ë°›ìœ¼ë ¤ë©´ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.04); margin-bottom:10px;">
        <div>
          <div style="font-weight:600;">í‘¸ì‹œ ì•Œë¦¼ ë°›ê¸°</div>
          <div class="hint" id="noticePermissionState">ê¶Œí•œ ìƒíƒœ: -</div>
        </div>
        <button id="noticeEnableBtn" type="button" class="primary mini" style="width:auto; padding:10px 12px;">ì•Œë¦¼ ì¼œê¸°</button>
      </div>

      <div class="hint" style="margin:0 2px 6px;">(ì„ íƒ) ì•Œë¦¼ì´ ì˜ ì˜¤ëŠ”ì§€ í™•ì¸</div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="noticeTestBtn" type="button" class="mini" style="width:auto; padding:10px 12px;">í…ŒìŠ¤íŠ¸ ì•Œë¦¼</button>
      </div>
    </div>
  </div>


  <!-- âœ… iOS ì„¤ì¹˜ ì•ˆë‚´ ëª¨ë‹¬ -->
  <div id="iosInstallModal" class="modal-backdrop" style="display:none;">
    <div class="modal" style="max-width:520px;">
      <h4 style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <span>iOS ì„¤ì¹˜ ë°©ë²•</span>
        <button id="iosInstallCloseBtn" type="button" class="mini" style="width:auto; padding:8px 10px;">ë‹«ê¸°</button>
      </h4>
      <div class="hint" style="margin:0 2px 10px;">
        iOS(Safari)ëŠ” ì„¤ì¹˜ íŒì—…ì´ ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤. ì•„ë˜ ìˆœì„œë¡œ â€œí™ˆ í™”ë©´ì— ì¶”ê°€â€ë¥¼ í•´ì£¼ì„¸ìš”.
      </div>
      <div style="font-size:13px; line-height:1.5; padding:0 2px;">
        1) Safariì—ì„œ ì´ í˜ì´ì§€ ì—´ê¸°<br>
        2) í•˜ë‹¨(ë˜ëŠ” ìƒë‹¨) <b>ê³µìœ </b> ë²„íŠ¼ ëˆ„ë¥´ê¸°<br>
        3) <b>í™ˆ í™”ë©´ì— ì¶”ê°€</b> ì„ íƒ<br>
        4) ì¶”ê°€ëœ ì•„ì´ì½˜ìœ¼ë¡œ ì‹¤í–‰
      </div>
    </div>
  </div>

</body>
</html>
