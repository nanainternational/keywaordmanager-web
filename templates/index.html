<!doctype html>
<html lang="ko">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Keyword Manager Web</title>

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg:#0b0d10;
      --panel:#11141a;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.9);
      --muted:rgba(255,255,255,.6);
      --blue:#4da3ff;
      --gray:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
      font-size:14px;
      font-weight:300;
    }
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:10px;
    }
    .section{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
    }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    h3{
      margin:0;
      font-size:14px;
      font-weight:600;
    }

    /* =========================
       ✅ Presence (Instagram style)
    ========================= */
    .presence-bar{
      display:flex;
      gap:10px;
      padding:8px 6px;
      margin-bottom:8px;
    }
    .presence-avatar{
      width:34px;
      height:34px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      font-size:14px;
      position:relative;
      cursor:default;
      user-select:none;
    }
    .presence-avatar.online{
      background:var(--blue);
      color:#fff;
    }
    .presence-avatar.offline{
      background:var(--gray);
      color:#fff;
      opacity:.65;
    }
    .presence-avatar:hover::after{
      content:attr(data-label);
      position:absolute;
      bottom:-30px;
      left:50%;
      transform:translateX(-50%);
      background:#000;
      color:#fff;
      padding:4px 8px;
      border-radius:8px;
      font-size:11px;
      white-space:nowrap;
      pointer-events:none;
      z-index:10;
    }

    /* =========================
       ✅ Chat
    ========================= */
    .chat-box{
      height:220px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chat-messages{
      flex:1;
      overflow:auto;
      padding:8px;
      border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
    }
    .msg{margin-bottom:8px}
    .msg.me{text-align:right}
    .bubble{
      display:inline-block;
      max-width:80%;
      padding:9px 11px;
      border-radius:14px;
      background:rgba(255,255,255,.07);
      border:1px solid var(--line);
      font-size:13px;
    }
    .msg.me .bubble{
      background:rgba(77,163,255,.16);
      border-color:rgba(77,163,255,.3);
    }
    .meta{
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }
    .chat-input-row{
      display:grid;
      grid-template-columns:80px 1fr 70px;
      gap:6px;
    }
    input,button{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
    }
    button.primary{
      background:rgba(77,163,255,.2);
      border-color:rgba(77,163,255,.35);
      font-weight:600;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="section">
    <div class="section-title">
      <h3>채팅</h3>
    </div>

    <!-- ✅ Presence -->
    <div class="presence-bar" id="presenceList"></div>

    <div class="chat-box">
      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input-row">
        <input id="chatSender" type="text" placeholder="이름">
        <input id="chatInput" type="text" placeholder="메시지 입력">
        <button id="sendBtn" class="primary" disabled>전송</button>
      </div>
    </div>
  </div>

</div>

<script>
/* =========================
   기본 유틸
========================= */
async function jget(u){return (await fetch(u)).json()}
async function jpost(u,b){return (await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).json()}

/* =========================
   채팅 활성화 제어
========================= */
const chatSender=document.getElementById("chatSender");
const chatInput=document.getElementById("chatInput");
const sendBtn=document.getElementById("sendBtn");

function updateChatEnabled(){
  const ok=(chatSender.value||"").trim().length>0;
  chatInput.disabled=!ok;
  sendBtn.disabled=!ok;
}
chatSender.addEventListener("input",updateChatEnabled);
updateChatEnabled();

/* =========================
   Client ID
========================= */
let CLIENT_ID=localStorage.getItem("client_id");
if(!CLIENT_ID){
  CLIENT_ID=crypto.randomUUID();
  localStorage.setItem("client_id",CLIENT_ID);
}

/* =========================
   Presence 시간 포맷
========================= */
function formatPresenceTime(iso){
  const diffMin=Math.floor((Date.now()-new Date(iso))/60000);
  if(diffMin<2)return"접속중";
  if(diffMin<60)return diffMin+"분전";
  const h=Math.floor(diffMin/60);
  if(h<24)return h+"시간전";
  return"1일전";
}

/* =========================
   Presence 렌더
========================= */
async function presenceRefresh(){
  const data=await jget("/api/presence/list?minutes=1440");
  if(!data.ok)return;
  const wrap=document.getElementById("presenceList");
  wrap.innerHTML="";
  data.users.forEach(u=>{
    const name=u.sender||"익명";
    const first=name.charAt(0);
    const state=formatPresenceTime(u.last_seen);
    const div=document.createElement("div");
    div.className="presence-avatar "+(state==="접속중"?"online":"offline");
    div.textContent=first;
    div.dataset.label=`${name} · ${state}`;
    wrap.appendChild(div);
  });
}
presenceRefresh();
setInterval(presenceRefresh,10000);

/* =========================
   Presence ping
========================= */
setInterval(()=>{
  jpost("/api/presence/ping",{client_id:CLIENT_ID,sender:chatSender.value});
},20000);
</script>

</body>
</html>
